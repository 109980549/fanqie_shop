var f_ajax=function(lay_data){var val=lay_data.elem.attributes;var str1,str2,str3;if(typeof(val.callBefore)!="undefined"){str1={"callBefore":val.callBefore.nodeValue}}if(typeof(val.callBack)!="undefined"){str2={"callBack":val.callBack.nodeValue}}str3={"url":val.url.nodeValue,"method":lay_data.form.method,"location":val.location.nodeValue,"tips":typeof(val.tips)!="undefined"?val.tips.nodeValue:"","datatype":typeof(val.datatype)!="undefined"?val.datatype.nodeValue:"json"};var options=$.extend({},str1,str2,str3);var defaults={callbackDelay:1000,threadLock:true,timeInterval:3000,method:"post",callBefore:function(){return true},callBack:function(data){try{layer.msg(data.message,{icon:data.state})}catch(e){layer.alert(data.message)}}};options=$.extend(defaults,options);sub(options);function sub(options){var params=getParams(options);options=$.extend(options,params);if(!options.callBefore()){return false}if(options.tips=="ok"){layer.confirm("确定要执行当前操作？",{btn:["是","否"]},function(index){if(options.method=="get"){ajaxGet(options,this)}else{ajaxPost(options,this)}layer.close(index)});return false}else{if(options.method=="get"){ajaxGet(options,this)}else{ajaxPost(options,this)}}return false}function getParams(data){var params=data;if($.type(params.callBefore)=="string"){params.callBefore=new Function("data","return "+params.callBefore)}if($.type(params.callBack)=="string"){params.callBack=new Function("data",params.callBack)}return params}function ajaxGet(params,obj){if(params.threadLock){btnLoading(obj)}var loads=layer.load(1,{shade:[0.5,"#000"]});$.get(params.url,{run:Math.random()},function(result){switch(params.datatype){case"html":params.callBack(result);break;case"json":var data=result;params.callBack(data);location(data);break;default:layer.alert("不支持的数据格式")}},params.datatype).fail(function(){layer.alert("网络异常，请联系客服")});if(params.threadLock){setTimeout(function(){layer.close(loads);btnReset(obj)},options.timeInterval)}}function ajaxPost(params,obj){if(params.threadLock){btnLoading(obj)}var formData=lay_data.field;var loads=layer.load(1,{shade:[0.5,"#000"]});$.post(params.url,formData,function(result){switch(params.datatype){case"html":params.callBack(result);break;case"json":var data=result;params.callBack(data);location(data);break;default:layer.alert("不支持的数据格式")}},params.datatype).fail(function(){layer.alert("网络异常，请联系客服")});if(params.threadLock){setTimeout(function(){layer.close(loads);btnReset(obj)},params.timeInterval)}}function btnLoading(obj){try{$(obj).css("pointer-events","none")}catch(e){$(obj).attr("disabled",true)}}function btnReset(obj){try{$(obj).removeAttr("style")}catch(e){$(obj).attr("disabled",false)}}function location(data){var location=options.location;if(location&&data.state==1){if(location=="reload"){setTimeout(function(){window.location.reload()},options.callbackDelay)}else{if(location=="close_iframe"){setTimeout(function(){parent.layer.closeAll("iframe")},options.callbackDelay)}else{if(location=="close_iframe_r"){setTimeout(function(){parent.layer.closeAll("iframe");parent.location.reload()},options.callbackDelay)}else{if(location=="close_all"){setTimeout(function(){parent.layer.closeAll()},options.callbackDelay)}else{setTimeout(function(){window.location.replace(location)},options.callbackDelay)}}}}}if(data.state==1){setTimeout(function(){layer.closeAll()},2000)}}};